## 4.4 라플라스 근사
4.5절에서는 베이지안 방법론을 적용한 로지스틱 회귀에 대해 논의할 것이다. 
그런데, 가능도 함수인 클래스 조건부 밀도가 가우시안 분포라고 할 수는 없으므로 사후 분포 역시 더 이상 가우시안 분포가 아니게 된다.... 
그래서 특정 형태의 근사법을 사용하게 되는데, 여러 근사법 중 해당 챕터에서는 라플라스 근사법(임의의 함수를 특정 위치에서 정규 분포로 근사하는 기법)
에 대해 짚고 넘어갈 것이다.

우선, 단일 연속 변수 Z의 경우를 살펴보자. 이 때, 분포를 가정하자. 
$$ p(z) = \frac{1}{Z}f(z) (식 4.125)$$
여기서 Z는 정규화 계수인데, 이 값은 아직 잘 모른다고 가정하자.   \
라플라스 근사법 목표는 분포 p(z)의 최빈값을 중심으로 한 가우시안 근사 q(z)를 찾아내는 것이다. \

1) p(z)의 최빈값을 구하자. 
$$ p'(z_0) = 0 $$
이 되는 $z_0$을 찾아야 한다. 
$$ \frac{df(z)}{dz}|(z=z_0) = 0  (식 4.126) $$

2) 최빈값을 중심으로 테일러 급수
테일러 급수란?   \
n차 방정식은 n+1번 미분하면 0이 되지만, 로그/지수/삼각함수는 무한히 미분이 가능하다.  \
이 때, 미분을 사용할 수 있도록 기존의 초월함수를 근사한 다항함수를 만들수 있다.  \
즉, 테일러는 모든 함수를 다항함수의 형태로 표현하고자 했다.  \
ex) y = f(x) 가 x=a에서 계속 미분가능한 경우 
$$ f(x) = f(a) + \frac{f'(a)}{1!}(x-a)  + \frac{f''(a)}{2!}(x-a)^2 + \frac{f'''(x)}{3!}(x-a)^3 + ...  $$
즉, f(x)를 무한급수(다항함수)로 나타낼 수 있다. 


가우시안 분포는 로그를 취한 결과가 이차 함수가 된다. \
최빈값 $ z_0 $를 중심으로 한 lnf(z)의 테일러 전개를 써보자. 우선, 최빈값을 중심으로 하므로 미분 = 0 즉, 일차항은 없어지고 다음과 같다. 
$$ lnf(z) ~ lnf(z_0) - \frac{1}{2}A(z-z_0)^2  (식 4.127) $$
여기서 A는? 
$$ A = - \frac{d^2}{dz^2}lnf(z) | z=z_0  (식 4.128) $$
암튼 여기에 지수 함수를 취하면 다음가 같지. 
$$ f(z) ~ f(z_0)exp(-\frac{A}{2}(z-z_0)^2)  (식 4.129) $$

3) 정규화 (이 때 가우시안 분포 형태를 잘 고려해보자. )
정구화된 가우시안 분포에 대한 표준방법을 사용해서 정규화된 분포를 구하자. 
$$ N(x| \mu, \sigma^2) = \frac{1}{(2 \pi \sigma^2)^{1/2}} exp(- \frac{1}{2 \sigma^2}(x-\mu)^2) (식 2.42) $$
$$ q(z) = (\frac{A}{2 \pi})^{1/2} exp(-\frac{A}{2}(z-z_0)^2) (식 4.130) $$

<img width="490" alt="image" src="https://user-images.githubusercontent.com/71582504/220542106-4bb8f586-06e6-472f-932c-e855fe69b7aa.png">


자. 이번에는 M차원 공간 z에 대해 정의된 분포에 대해서 라플라스 근사법을 확장해보자. \
![image](https://user-images.githubusercontent.com/71582504/220542945-18579379-2409-4c4a-8490-bd5672bb0d9c.png)

이 때 임계점 $z_0$에 대해서 기울기는 0이 될 것이다. 이 임계점 근처에 대해서 테일러 전개를 시행하면 다음과 같다. 
$$ lnf(z) = lnf(z_0) - \frac{1}{2}A(z-z_0)^2  (식 4.127) $$
여기에 똑같이 지수함수를 취하면, 
$$ f(z) = f(z_0)exp(-\frac{1}{2}(z-z_0)^T A(z-z_0))  (식 4.133) $$

이번에도 정규화를 할 텐데 이번엔 다변량 가우시안 분포에 대한 표준방법을 사용하자. 
$$ N(x| \mu, \Sigma) = \frac{1}{(2 \pi)^{D/2}} \frac{1}{|\Sigma|^{1/2}} exp(-\frac{1}{2}(x-\mu)^T \Sigma^{-1} (x-\mu)) (식 2.43) $$
이걸 사용하면, 
$$q(z) = \frac{|A|^{1/2}}{(2\pi)^{M/2}} exp(-\frac{1}{2}(z-z_0)^T A(z-z_0)) = N(z|z_0, A^{-1})$$

여기서, 참고로 M X M 행렬 A는 헤시안 행렬이다. 
헤시안 행렬이란? 
임계점에서 헤시안 행렬의 고유값들의 부호에 따라서, 최대(음수)/최소(양수)/안장점(양수 & 음수)인지가 달라지는데....
기하학적으로 Hessian matrix가 시행하고 있는 선형 변환은 기본 bowl 형태의 함수를 좀 더 볼록하거나 오목하게 만드는 변환이다.
좀 더 쉬운말로 하면, 헤시안 행렬을 이용하면 특정 함수의 특정 위치가 위로 볼록한지, 아래로 볼록한지, 안장점인지를 판단할 수 있다는 의미이다.
https://raw.githubusercontent.com/angeloyeo/gongdols/master/%EB%AF%B8%EC%A0%81%EB%B6%84%ED%95%99/%ED%97%A4%EC%8B%9C%EC%95%88%20%ED%96%89%EB%A0%AC%EC%9D%98%20%EC%9D%98%EB%AF%B8/fig4.gif

https://raw.githubusercontent.com/angeloyeo/gongdols/master/%EB%AF%B8%EC%A0%81%EB%B6%84%ED%95%99/%ED%97%A4%EC%8B%9C%EC%95%88%20%ED%96%89%EB%A0%AC%EC%9D%98%20%EC%9D%98%EB%AF%B8/fig3.gif

|A|가 위 식에 있지. 즉, 항상 양의 정부호 행렬이므로 z_0가 최솟값이나 안장점이 아니라 지역적 최댓값이라는 것이다. 

자 지금까지는 가능도 함수를 가우시안 분포로 근사하는 과정까지 했다. 
참고로, 라플라스 근사법의 가장 큰 한계점은 global적으로 분포를 바라보고 있지 않다는 것.! \
즉, 양봉형 분포에서는 어떤 최빈값을 선택하는지에 따라서 라플라스 근사가 달라지게 된다는 것이다. \


## 4.4.1 모델 비교와 베이지안 정보 기준
위에서 정규화 계수 Z는 unknown으로 남겨도 된다고 했다.
하지만 모델 선택을 위해서는 p(z)를 구할려면 정규화 상수의 근사치를 찾아야 한다. 
$$ p(z) = \frac{1}{Z}f(z) (식 4.125)$$
분포 p(z) 뿐 아니라, 정규화 상수 Z의 근사치도 구해보자. 
아까 보면, 
$$ Z = \int f(z)dz $$
$$ Z = f(z_0)\int exp(-\frac{1}{2} A (z-z_0)^T A(z-z_0)) dz $$
$$ Z = f(z_0)\frac{(2\pi)^{M/2}}{|A|^{1/2}} \int \frac{|A|^{1/2}}{(2\pi)^{M/2}} exp(-\frac{1}{2} A (z-z_0)^T A(z-z_0)) dz $$
여기서 가우시안 분포 적분의 합은 1이므로 오른쪽 항이 사라지고 남은 건
$$ Z = f(z_0)\frac{(2\pi)^{M/2}}{|A|^{1/2}} $$ 
이걸 사용해서, 모델 증거의 근삿값을 구할 수 있다. 

여러 모델 중 하나의 모델을 선택할 때, p(D|Mi)의 확률 값을 비교하는 과정을 거친다. 
모델 증거(model evidence)의 식은 다음과 같다. 
$$ p(D)=\intp(D|θ)p(θ)dθ (4.136) $$
이 때 θ
 는 모델에 종속적이며 우리는 p(D|θ)p(θ)
 를 가우시안 형태로 근사함

이제 f(z)=p(D|z)p(z)
 라 하여 정규화 상수 Z
 전개식에 대입하여 풀어본다.

그러면 Z=p(D)
 가 된다.
여기에 로그를 취하면,
## 4.5 베이지안 로지스틱 회귀
이제 로지스틱 회귀의 베이지안적 방법론에 대해서 살펴보자.
로지스틱 회귀의 정확한 베이지안적 추론은 다루기가 어렵다. 사후 분포를 계산하기 위해서는 사전 분포와 가능도 함수를 곱한 값을 정규화해야 하는데, 가능도 함수 그 자체가 각 데이터 포이느마다 로지스틱 시그모이드 함수를 모두 곱한 값에 해당하기 때문이다. 
예측 분포를 계산하는 것 역시 비슷한 이유로 다루기가 매우 어렵다. 따라서, 여기서는 베이지안 로지스틱 회귀 문제에 라플라스 근사를 적용할 것이다. 

## 4.5.1 라플라스 근사
라플라스 근사는 사후 분포의 최빈값을 찾아낸 후 이 최빈값을 중심으로 하는 가우시안 분포를 근사함으로써 이루어진다.  \
이를 위해서는 로그 사후 분포의 이차 미분값을 계산할 수 있어야 하는데, 이는 헤시안 행렬을 찾는 것과 동일한 문제다. \

사후 분포의 가우시안 표현을 찾는 것이 목표인 만큼 일반 형태로 적을 수 있는 가우시안 사전 분포에서부터 시작해보자. 
$$ p(w) = N(w|m_0, S_0)  (식 4.140) $$

